## Модификация клавиатуры под себя в macOS

### Средства операционной системы

Как можно бороться с неудобной клавишей <Esc>?

https://csswizardry.com/2017/01/preparing-vim-for-apples-touch-bar/ Раздел Remap Other Keys

### Karabiner-Elements

Для удобства маппинга клавиш и управления правилами мы можем воспользоваться
новой утилитой
[Karabiner-Elements](https://github.com/tekezo/Karabiner-Elements), которая
доступна под macOS Sierra (10.12) и выше. Существовала более старая версия без
приставки `Elements` для устаревших ОС, но здесь мы ее рассматривать не будем.

Маппинги в Karabiner-Elements можно разделить на две большие группы: Simple и
Complex Modification. Для первых характерно простое переназначение с одной клавиши на
другую (From key To key), дополнительно используя возможности
клавиш-модификаторов или не учитывая их. Кроме того, в простейших случаях в
текущей версии программы можно выполнять сопоставление клавиш прямо через GUI.
Для комплексных модификаций вам в любом случае придется описывать правила в
формате JSON.

Настоятельно рекомендую обратить внимание на встроенную в Karabiner-Elements
утилиту `EventViewer`, которая поможет понять как называются в вашей системе те
или иные клавиши и поможет получить уже готовые сниппеты для ваших
конфигурационных файлов.

Рассмотрим простое правило, описанное в формате JSON:

```json
{
    "from": {
        "key_code": "d",
        "modifiers": {
            "mandatory": [
                "left_gui",
                "left_alt"
            ],
            "optional": [
                "any"
            ]
        }
    },
    "to": [
        {
            "key_code": "f1"
        }
    ],
    "type": "basic"
}
```

Давайте взглянем на главный конфигурационный файл
`~/.config/karabiner/karabiner.json`, который содержит все активированные
правила (поэтому он может быть достаточно большим). Мы можем его
отредактировать и добавить свои дополнения. Этот файл автоматически
перегружается программой Karabiner-Elements при изменении, таким образом мы
легко сможем протестировать свои догадки. В случае каких-либо проблем нам также
окажет неоценимую помощь вкладка `Log`, которая сообщениями красного цвета
отобразит некорректные значения или ошибки в конфигурации или же другие проблемы
с вашими модификациями.

Начать ее изучение синтаксиса конфигурационных файлов нужно с
[документации](https://pqrs.org/osx/karabiner/json.html), следуя которой можно
попробовать облегчить себе жизнь и сразу внедрить пару "приемчиков". Давайте
рассмотрим пример, когда у нас есть две раскладки клавиатуры (английская и
русская) и мы хотим во-первых организовать переключение с использованием только
одной кнопки для каждого случая, а во-вторых - реализовать идемпотентное их
переключение.

На роль подопытных клавиш мы выберем левый и правый Command, что позволит плавно
отказаться от подобного переключения с помощью системной комбинации клавиш
(фактически нажимаем все то же самое, но без необходимости тянуться к пробелу).

Давайте в EventViewer во первой вкладке `Main` понажимаем оба Command и
определим их правильные названия для конфигурационного файла. Во вкладке
`Variables` доступны подсказки с наименованием текущей раскладки клавиатуры
`com.apple.keylayout.чего_то_там`, которые нам также в дальнейшем понадобятся.

Для выполнения нашего упражнения кроме чтения документации вам, вероятно, может
понадобиться
[подсказка](https://github.com/pqrs-org/KE-complex_modifications/blob/master/src/json/example_select_input_source.json.erb),
однако настоятельно рекомендую воспользоваться ей только после того, как ваши
эксперименты зайдут в тупик.

### Домашние задания

Найдите на странице документации и разберите примеры:
1. Как инвертировать символы `;` и `:` на их кнопке?
2. Как сделать `Ctrl-H` аналогом `Backspace` и `Ctrl-Opt-H` аналогом `Delete`?
3. Запретить использование `Cmd-l` в приложении Finder
4. При нажатии клавиши `LCtrl` без комбинаци с другой выдавать `Escape`
5. Открывать заданное приложение при удерживании клавиши `Escape`
6. При двойном нажатии правого `Shift` запускать приложение `Mission Control`
7. При одновременном нажатии клавиш `=` и `Delete` выполнять функцию прямого
   `Delete`?

Внедрите пару из описанных приемов в свой рабочий процесс.

### Готовые маппинги в Karabiner-Elements

1. `Caps Lock` сейчас самая бесполезная клавиша, так как практически не
   используется в нашей повседневной работе. С другой стороны - она находится в
   домашнем ряду и поэтому будет неправильно, если мы ее нигде не задействуем. У
   нас есть частоиспользуемая клавиша в Vim `Escape`, переключающая режимы, вот
   ее и перенесем поближе. Вторая идея связана с другой популярной клавишей
   `Ctrl`, об которую тоже приходится ломать пальцы. Давайте сделаем так: нажали
   и сразу отпустили - значит это `Escape`, зажали, удерживаем и щелкаем по еще
   одной кнопке - то это `Ctrl`. Так как этих модификатора для разгрузки рук
   должно быть два, приспособим под правый `Ctrl` симметричную на домашнем ряду
   клавишу `Enter`. Готовые настройки находятся [на странице
   Karabiner](https://pqrs.org/osx/karabiner/complex_modifications/#modifier-keys)
   под названием `Caps and return to ctrl. Ctrl to caps.`. Импортируем их,
   подключаем и отключаем старые клавиши `Ctrl` и `Escape` (а как иначе привыкать?).
   Пробуем работать по новой схеме ближайшую неделю и потом возвращаемся сюда
   внедрять новые пункты.
*  Внедряем блокировки `Force the user to make key combination with two hands`
*  Не тянемся за скобками - `Better Shifting: Parentheses on shift keys`
* Change input source to U.S. by left_command, RussianWin by right_command.

